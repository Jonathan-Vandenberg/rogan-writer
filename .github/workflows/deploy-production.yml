name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      
    - name: Check System Info
      run: |
        echo "Node version: $(node -v)"
        echo "NPM version: $(npm -v)"
        echo "Architecture: $(uname -m)"
        echo "OS: $(uname -s)"
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.18.0'
        architecture: 'x64'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install Dependencies
      run: npm install --legacy-peer-deps
      
    - name: Set up environment files
      run: |
        # Create .env file for production
        echo "NODE_ENV=production" > .env
        echo "PORT=3000" >> .env
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
        echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env
        echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
        echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
        echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
        echo "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}" >> .env
        echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
        echo "S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}" >> .env
        echo "AUTH_TRUST_HOST=true" >> .env
        
        # Copy .env to .env.local for build process
        cp .env .env.local

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Build Application
      run: npm run build
      env:
        NODE_ENV: production
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

    - name: Prepare for deployment
      run: |
        # Create deployment directory structure
        mkdir -p deploy
        
        # Copy necessary files for deployment
        cp -r .next deploy/
        cp -r public deploy/
        cp -r prisma deploy/
        cp -r node_modules deploy/
        cp package.json deploy/
        cp package-lock.json deploy/
        cp .env deploy/
        cp next.config.ts deploy/ || true
        
        # Copy additional config files if they exist
        cp middleware.ts deploy/ || true
        cp tsconfig.json deploy/ || true
        cp components.json deploy/ || true
        
        # Set correct permissions
        chmod -R 755 deploy

    - name: Deploy application to DigitalOcean
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DIGITALOCEAN_HOST }}
        username: ${{ secrets.DIGITALOCEAN_USERNAME }}
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        source: "./deploy/*"
        target: "/var/www/rogan-writer"
        strip_components: 1
        rm: true
        debug: true

    - name: Verify deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DIGITALOCEAN_HOST }}
        username: ${{ secrets.DIGITALOCEAN_USERNAME }}
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        script: |
          echo "=== DEBUG: Connection Info ==="
          echo "Connected as user: $(whoami)"
          echo "Home directory: $HOME"
          echo "Current directory: $(pwd)"
          echo "IP: $(hostname -I)"
          echo ""
          echo "=== Verifying deployment ==="
          cd /var/www/rogan-writer
          echo "Current directory after cd: $(pwd)"
          echo "Files in /var/www/rogan-writer:"
          ls -la
          echo ""
          echo "File timestamps:"
          stat /var/www/rogan-writer/ 2>/dev/null || echo "Directory stat failed"
          echo ""
          echo "Checking critical files:"
          test -f package.json && echo "✅ package.json exists" || echo "❌ package.json MISSING"
          test -d .next && echo "✅ .next directory exists" || echo "❌ .next MISSING"
          test -d node_modules && echo "✅ node_modules exists" || echo "❌ node_modules MISSING"
          test -f .env && echo "✅ .env exists" || echo "❌ .env MISSING"
          echo ""
          echo "=== Searching entire filesystem for package.json ==="
          find /var/www -name "package.json" -type f 2>/dev/null | head -10

    - name: Run database migrations and start application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DIGITALOCEAN_HOST }}
        username: ${{ secrets.DIGITALOCEAN_USERNAME }}
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        script: |
          cd /var/www/rogan-writer
          
          # Set environment variables
          export NODE_ENV=production
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          export NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          export NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          export GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}"
          export GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}"
          export ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"
          export AWS_REGION="${{ secrets.AWS_REGION }}"
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
          
          # Run database migrations safely
          npx prisma migrate deploy
          npx prisma generate
          
          # Stop existing PM2 process if running
          pm2 stop rogan-writer || true
          pm2 delete rogan-writer || true
          
          # Kill any process on port 3000
          fuser -k 3000/tcp || true
          sleep 2
          
          # Start the application with PM2
          NODE_ENV=production pm2 start npm --name "rogan-writer" -- start
          
          # Save PM2 configuration
          pm2 save
          pm2 startup || true
          
          # Show PM2 status
          pm2 list
