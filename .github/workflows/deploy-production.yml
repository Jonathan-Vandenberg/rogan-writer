name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check System Info
      run: |
        echo "Node version: $(node -v)"
        echo "NPM version: $(npm -v)"
        echo "Architecture: $(uname -m)"
        echo "OS: $(uname -s)"
        
    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18.18.0'
        architecture: 'x64'
        cache: 'npm'

    - name: Set up environment files
      run: |
        # Create production .env.local file directly from secrets (Next.js convention)
        echo "NODE_ENV=production" > .env.local
        echo "PORT=3000" >> .env.local
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.local
        echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env.local
        echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env.local
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
        echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env.local
        echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env.local
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env.local
        echo "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}" >> .env.local
        echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env.local
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env.local
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env.local
        echo "S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}" >> .env.local
        
        # Add trusted hosts for NextAuth (both www and non-www)
        echo "AUTH_TRUST_HOST=true" >> .env.local
        
        # Copy .env.local to .env for compatibility
        cp .env.local .env
    - name: Install dependencies
      run: npm install --legacy-peer-deps
        
    - name: Generate Prisma client
      run: |
        echo "Cleaning Prisma cache..."
        rm -rf node_modules/.prisma
        rm -rf node_modules/@prisma/client
        echo "Generating Prisma client from schema..."
        npx prisma generate
      
    - name: Build application
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}

    - name: Prepare for deployment
      run: |
        # Create deployment directory structure
        mkdir -p deploy
        
        # Copy necessary files for deployment
        cp -r .next deploy/
        cp -r public deploy/
        cp -r prisma deploy/
        cp -r node_modules deploy/
        cp package.json deploy/
        cp package-lock.json deploy/
        cp .env.local deploy/
        cp .env deploy/
        cp next.config.ts deploy/ || true
        
        # Create config directory with .env.production
        mkdir -p deploy/config
        cp .env.local deploy/config/.env.production
        
        # Set correct permissions
        chmod -R 755 deploy
        chmod 644 deploy/package.json
        
        # Verify files are ready for deployment
        echo "Verifying deployment files..."
        ls -la deploy/
        echo "Checking .next directory..."
        ls -la deploy/.next/ | head -10
        echo "Checking package.json..."
        test -f deploy/package.json && echo "✅ package.json exists" || echo "❌ package.json MISSING"
        
    - name: Deploy to DigitalOcean
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DIGITALOCEAN_HOST }}
        username: ${{ secrets.DIGITALOCEAN_USERNAME }}
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        source: "./deploy/*"
        target: "/var/www/rogan-writer"
        strip_components: 1
        overwrite: true
        
    - name: Verify deployment on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DIGITALOCEAN_HOST }}
        username: ${{ secrets.DIGITALOCEAN_USERNAME }}
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        script: |
          echo "Verifying files on server..."
          cd /var/www/rogan-writer
          ls -la
          echo "Checking .next directory..."
          ls -la .next/ 2>/dev/null | head -5 || echo "❌ .next directory MISSING"
          echo "Checking package.json..."
          test -f package.json && echo "✅ package.json exists" || echo "❌ package.json MISSING"
          echo "Checking node_modules..."
          test -d node_modules && echo "✅ node_modules exists" || echo "❌ node_modules MISSING"

    - name: Start application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DIGITALOCEAN_HOST }}
        username: ${{ secrets.DIGITALOCEAN_USERNAME }}
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        script: |
          cd /var/www/rogan-writer
          
          # Install ALL dependencies (Prisma CLI is needed)
          echo "Installing dependencies..."
          npm install --legacy-peer-deps
          
          # Copy config/.env.production to .env.local in root (Next.js uses .env.local)
          echo "Loading production environment from config..."
          cp config/.env.production .env.local
          cp config/.env.production .env
          
          # Verify .env.local exists
          if [ ! -f .env.local ]; then
            echo "ERROR: .env.local not found after copying from config!"
            exit 1
          fi
          
          # Generate Prisma client (skip postinstall errors)
          echo "Generating Prisma client..."
          npx prisma generate || echo "Prisma generate completed with warnings"
          
          # Run database migrations
          echo "Running database migrations..."
          npx prisma migrate deploy
          
          # Stop and delete existing PM2 process
          echo "Stopping existing PM2 process..."
          pm2 stop rogan-writer || true
          pm2 delete rogan-writer || true
          pm2 kill || true
          
          # Kill any process using port 3000 (try multiple methods)
          echo "Killing any process on port 3000..."
          # Method 1: lsof
          lsof -ti:3000 | xargs kill -9 2>/dev/null || true
          # Method 2: fuser (more reliable)
          fuser -k 3000/tcp 2>/dev/null || true
          # Method 3: netstat + kill
          netstat -tlnp 2>/dev/null | grep :3000 | awk '{print $7}' | cut -d'/' -f1 | xargs kill -9 2>/dev/null || true
          # Method 4: ss + kill
          ss -tlnp 2>/dev/null | grep :3000 | awk '{print $6}' | cut -d',' -f2 | cut -d'=' -f2 | xargs kill -9 2>/dev/null || true
          
          # Wait for port to be released
          echo "Waiting for port 3000 to be released..."
          sleep 5
          
          # Verify port is free
          if command -v lsof >/dev/null 2>&1; then
            if lsof -ti:3000 >/dev/null 2>&1; then
              echo "WARNING: Port 3000 is still in use!"
              lsof -ti:3000 | xargs kill -9 2>/dev/null || true
              sleep 3
            fi
          fi
          
          # Start application
          echo "Starting application with PM2..."
          NODE_ENV=production pm2 start npm --name "rogan-writer" -- start
          
          # Save PM2 configuration
          pm2 save
          
          # Show status and logs
          sleep 5
          pm2 status
          pm2 logs rogan-writer --lines 30 